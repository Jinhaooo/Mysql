# 执行一条Selcet语句后发生了什么
## MySQL的整体架构
<img width="1261" height="721" alt="image" src="https://github.com/user-attachments/assets/709866be-0470-4a46-9c6a-6b0da5292229" />  
MySQL的架构分为两层，Server层和存储引擎层。  
Server层负责建立连接，分析和执行SQL。MySQL 大多数的核心功能模块都在这实现，主要包括连接器，查询缓存、解析器、预处理器、优化器、执行器等。另外，所有的内置函数（如日期、时间、数学和加密函数等）和所有跨存储引擎的功能（如存储过程、触发器、视图等。）都在 Server 层实现。  

存储引擎层主要负责数据的存取和提取。支持 InnoDB、MyISAM、Memory 等多个存储引擎，不同的存储引擎共用一个 Server 层。现在最常用的存储引擎是 InnoDB，从 MySQL 5.5 版本开始，InnoDB 成为了 MySQL 的默认存储引擎。我们常说的索引数据结构，就是由存储引擎层实现的，不同的存储引擎支持的索引类型也不相同，比如 InnoDB 支持索引类型是 B+树 ，且是默认使用，也就是说在数据表中创建的主键索引和二级索引默认使用的是 B+ 树索引。  

## 第一步：连接器
首先我们要建立MySQL连接，MySQL是基于TCP协议传输的，所以需要先经过三次握手。  
如果完成TCP连接的建立，连接器会验证用户名和密码，如果没有问题，连接器就会保存用户的权限，后续该用户在此连接里的任何操作，都会基于连接开始时读到的权限进行权限逻辑的判断。  
所以，如果一个用户已经建立了连接，即使管理员中途修改了该用户的权限，也不会影响已经存在连接的权限。修改完成后，只有再新建的连接才会使用新的权限设置。  
MySQL同样支持长连接，但是，使用长连接后可能会占用内存增多，因为 MySQL 在执行查询过程中临时使用内存管理连接对象，这些连接对象资源只有在连接断开时才会释放。  
如何解决长连接占用内存过多的问题呢？一般有两种办法：1.定期断开长连接。 2.客户端主动重置连接。  

## 第二步：查询缓存
连接器完成工作后，Server层会解析SQL语句的第一个字段，如果是SELECT语句，MySQL就会去查询缓存。  
但是，对于更新比较频繁的表，查询缓存的命中率很低的，因为只要一个表有更新操作，那么这个表的查询缓存就会被清空。所以在MySQL8.0后，查询缓存这个功能就被删掉了。  

## 第三步：解析SQL
在正式执行 SQL 查询语句之前， MySQL 会先对 SQL 语句做解析，这个工作交由「解析器」来完成。  
### 解析器
首先，解析器会进行词法分析，MySQL 会根据你输入的字符串识别出关键字出来。  
<img width="738" height="172" alt="image" src="https://github.com/user-attachments/assets/f04eb299-922e-463c-b92c-330dfaa6b62a" />  
然后会进行语法分析。根据词法分析的结果，语法解析器会根据语法规则，判断你输入的这个 SQL 语句是否满足 MySQL 语法，如果没问题就会构建出 SQL 语法树，这样方便后面模块获取 SQL 类型、表名、字段名、 where 条件等等。  
<img width="1572" height="800" alt="image" src="https://github.com/user-attachments/assets/2d14c2c2-ad33-41bf-a228-01c09dbaf870" />  
如果输入的SQL语法不对，解析器就会报错。  

## 第四步：执行SQL
经过解析器后，接着就要进入执行 SQL 查询语句的流程了，每条SELECT 查询语句流程主要可以分为下面这三个阶段：  
每条SELECT 查询语句流程主要可以分为下面这三个阶段：  
optimize 阶段，也就是优化阶段；  
execute 阶段，也就是执行阶段；  
### 预处理器
预处理器会检查 SQL 查询语句中的表或者字段是否存在；然后将 select * 中的 * 符号，扩展为表上的所有列。  
### 优化器
优化器主要负责将 SQL 查询语句的执行方案确定下来，比如在表里面有多个索引的时候，优化器会基于查询成本的考虑，来决定选择使用哪个索引。  
### 执行器
经历完优化器后，就确定了执行方案，接下来 MySQL 就真正开始执行语句了，这个工作是由「执行器」完成的。在执行的过程中，执行器就会和存储引擎交互了，交互是以记录为单位的。

总结：  
执行一条 SQL 查询语句，期间发生了什么？  
连接器： 建立连接，管理连接，校验用户身份。  
查询缓存： 查询语句如果命中查询缓存则直接返回，否则继续往下执行。MySQL 8.0 已删除该模块；  
解析SQL：通过解析器对SQL语句进行词法分析和语法分析，然后构建语法树，方便后续模块读取表名、字段、语句类型；
执行SQL：  
预处理阶段：检查表或字段是否存在；将 select * 中的 * 符号扩展为表上的所有列。  
优化阶段： 基于查询成本，确定执行查询的方案。  
执行器： 根据执行计划执行 SQL 查询语句，从存储引擎读取记录，返回给客户端。




